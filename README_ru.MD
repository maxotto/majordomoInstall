# majordomoInstall
Помогает установить систему умного дома [MajorDoMo](http://majordomo.smartliving.ru/)  на Raspberry PI 3. Состоит из двух скриптов. Первый обеспечивает подключение новых источников и проводит апдейт и апгрейд системы. Второй проводит собственно установку системы. Также выложен файл примера для использования его при редактировании crontab.

## Исходное состояние
Рекомендуется использовать свежую инсталляцию Raspbian OS версии jessie. Я использовал [NOOBS](https://www.raspberrypi.org/downloads/noobs/ "download page"). Настройте минимально необходимые вещи, чтобы потом к ним не возвращаться - включите SSH, настройте WiFi соединение, зону времени, локали. Все дальнейшие действия удобно делать из графического интерфейса OS.
## Шаг 1 - Подготовка
Откройте терминал, запускайте команды:

1 - `git clone https://github.com/maxotto/majordomoInstall.git`

2 - `cd majordomoInstall`

3 - `bash 1-updateUpgradeReboot.sh`

Последняя строка скрипта перегружает Raspberry PI. Такое поведение можно отключить, закомментировав эту строку в редакторе

`nano 1-updateUpgradeReboot.sh`

После этого шага я обычно делаю полный бэкап SD карточки, чтобы больше к этому не возвращаться. Если что-то пошло не так, просто восстанавливаю этот бэкап и продолжаю эксперименты.

## Шаг 2 - Собственно установка
Запустите терминал, войдите в директорию со скриптами

`cd majordomoInstall`

Отредактируйте файл второго скрипта `nano 2-lampMajordomo.sh`. установите в нем свой пароль для доступа в БД MySql `DB_PASSWORD="YourLovelyPassWord"`. Используте этот же пароль при дальнейшей инсталляции MySql и PhpMyAdmin. Затем выполните скрипт:

`bash 2-lampMajordomo.sh`

В процессе исполнения скрипта устанавливаются необходимые компоненты. Это стек LAMP или просто утилиты, типа MC, или те, что необходимы для работы MajorDoMo (mplayer, vlc, mosquitto  и.т.п). Загляните в скрипт и, при необходимости, отредактируйте перечень таких утилит.

Также есть строки изменяющие настроечные файлы PHP. В скрипте они даны скорее как пример, взяты из другого проекта. Могут быть неоптимальны для нашего случая. Будут корректироваться по мере необходимости.

В процессе инсталляции будет создаваться файл `crontab`. Вы попадете в соответствующий редактор, где надо будет указать команды, запускаемые при старте операционной системы. Для подсказки используйте файл `crontab.example` или возьмите строки непосредственно из  скрипта `2-lampMajordomo.sh`, не забыв удалить символ комментария #

Обратите внимание на последнюю строку скрипта - `sudo /usr/bin/php /var/www/html/cycle.php`. Я так делаю для того, чтобы именно этот скрипт создал некоторые папки с системе. Тогда они приобретают нужные права (777) и Главный Цикл не дает сообщений об ошибках. Если же мы первым делом запустим WEB-интерфейс MajorDoMo, то нужные папки создадутся с правами 771 и Главный Цикл будет ругаться.

Вот и все. После этого откройте в браузере адрес 127.0.0.1. Должна открыться начальная страница системы. После этого можно перегрузиться `sudo reboot`. После перезагрузки надо убедиться, что наши строки, вставленные в crontab, отработали нормально. Для этого смотрим в WEB-интерфейсе состояние главного цикла. 

Если что-то пошло не так, проверяем наличие файла `reboot.txt` в домашней папке. Если он есть и он имеет время перезагрузки, то значит строки crontab отработали. Если же этого файла нет, то надо вручную запустить `crontab -e` и повторить настройку автозапуска Главного Цикла. 
